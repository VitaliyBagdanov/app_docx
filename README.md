# Docx Template Generation API

Генерация docx-файлов по шаблону и данным из Postgres

## О проекте

Этот сервис позволяет автоматически генерировать документы в формате `.docx` на основе заранее подготовленного шаблона и данных, хранящихся в базе Postgres. Проект реализован на FastAPI и поддерживает как базовую версию генерации файлов, так и более гибкий V2 API с подстановкой любых значений.

---

## Возможности

- Подключение к PostgreSQL для получения данных для шаблона
- Загрузка docx-шаблона и автоматическая подстановка значений по ключам вида `{tag}`
- API, позволяющее получать готовые docx-файлы в ответ
- Поддержка расширенного режима, где значения для шаблона можно передавать в теле запроса
- Пример обработки дат в русском формате

---

## Быстрый старт

### 1. Клонируйте репозиторий

```
git clone https://github.com/VitaliyBagdanov/app_docx
cd app_docx
```

### 2. Установите зависимости

```
pip install -r requirements.txt
```

или вручную:

```
pip install fastapi[all] asyncpg python-docx pydantic
```

### 3. Настройте переменные окружения

Создайте `.env` файл или экспортируйте переменные:



Шаблон docx необходимо положить в `DOCX_SHARED_DIR`.

---

## Описание API

### Основной эндпоинт

#### V1: `/generate-docx` (POST)

**Тело запроса:**
```json
{
  "id": 1
}
```

**Описание:**  
Генерирует docx-файл по шаблону, подставляя значения из строки таблицы `mfg_bot` по указанному `id`.

**Ответ:**
```json
{
  "status": "success",
  "filename": "1_output.docx",
  "detail": "File generated and saved in shared_data."
}
```

---

#### V2: `/v2/generate-docx` (POST)

**Тело запроса:**
```json
{
  "id": 1,
  "values": {
    "имя": "Иван",
    "custom_tag": "Значение"
  }
}
```
`values` — необязательный словарь, которым можно переопределить любые значения шаблона.

**Ответ:**  
На выходе вернётся docx-файл с корректно проставленными значениями.

---

## Структура таблицы mf

Обязательно должны быть поля, совпадающие с тегами в вашем docx-шаблоне, например: `secretary`, `body`, и другие динамические.

---

## Как работает парсер шаблонов

Шаблон должен содержать плейсхолдеры вида `{tag}` в тексте или таблицах документа Word. Парсер ищет такие теги, извлекает их, формирует динамический SQL-запрос к базе, подставляет значения и генерирует финальный docx-файл с заменёнными значениями.

---

## Дополнительные детали

- Русские даты форматируются в виде: `01 января 2024 года`
- В случае ошибки процесс генерации завершится с описанием проблемы (например, шаблон не найден или документ по id отсутствует в базе)

---

## Запуск

```
uvicorn app.main:app --reload
```

Документация FastAPI будет доступна на `/docs`.

---

## Структура репозитория (кратко)

- `app/config.py` — конфигурация через pydantic
- `app/db.py`, `app/db_v2.py` — работа с PostgreSQL
- `app/docx_handler.py` — обработка docx-шаблонов и подстановка значений
- `app/main.py` — основной вход и запуск приложения FastAPI
- `app/v2/routes.py` — расширенные маршруты для v2

---

## Контакты

Vitaliy Bagdanov  
[GitHub](https://github.com/VitaliyBagdanov/app_docx)

---
